<!doctype html>
<html lang="en">
<meta charset="UTF-8" />
<meta content="width=device-width,initial-scale=1" name="viewport" />
<meta content="no-referrer" name="referrer" />
<link href="data:image/x-icon;," rel="icon" />
<title>github.com/dbghelp</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.11.2/controls.min.css" rel="stylesheet" />
<link href="https://dbghelp.github.io/xml-epg.css" rel="stylesheet" />
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
    background-color: #282c34;
  }
  #playlist {
    width: 350px;
    background-color: #282c34;
    color: #fff;
    overflow-y: auto;
    border-right: 1px solid #444;
    padding: 20px;
    box-shadow: 2px 0 5px rgb(0 0 0 / 0.2);
    display: flex;
    flex-direction: column;
  }
  #search-input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #444;
    border-radius: 5px;
    background-color: #3c4043;
    color: #fff;
    font-size: 1em;
    box-sizing: border-box;
  }
  #epg-button {
    display: none;
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    background-color: #61dafb;
    color: #000;
    border: none;
    border-radius: 5px;
    font-size: 1em;
    cursor: pointer;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.3);
  }
  #epg-button:hover {
    background-color: #4fa3c4;
  }
  #video-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    z-index: 2;
    position: relative; /* importante per Shaka UI overlay */
  }
  #video {
    flex: 1;
    width: 100%;
    height: 100%;
    background-color: #000;
  }
  #video-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  /* Canali singoli */
  #video-list li {
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
  }
  #video-list li:hover {
    background-color: #61dafb;
    transform: scale(1.05);
  }
  #video-list img {
    width: 50px;
    height: 50px;
    margin-right: 10px;
    border-radius: 5px;
    object-fit: contain;
  }
  .video-title {
    font-size: 1em;
  }
  .active {
    background-color: #4fa3c4;
  }
  #overlay {
    display: none;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
    z-index: 2;
    flex: 1;
  }
  #epg-container {
    display: none;
    z-index: 1000;
    position: fixed;
    width: 100%;
    height: 100%;
    overflow-y: scroll;
    overflow-x: scroll;
    background-color: #282c34;
  }
</style>

<div id="playlist">
  <input id="search-input" placeholder="Search..." />
  <ul id="video-list"></ul>
  <button id="epg-button" onclick="openEPG()">EPG</button>
</div>

<div id="video-container">
  <video autoplay controls id="video"></video>
</div>

<div id="overlay"></div>
<div id="epg-container"></div>

<!-- Shaka Player core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.11.2/shaka-player.compiled.js"></script>
<!-- Shaka Player UI -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.11.2/shaka-player.ui.min.js"></script>
<!-- Altri script esterni -->
<script src="https://dbghelp.github.io/M3U8Interpreter.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://dbghelp.github.io/xml-epg.js"></script>

<script>
  const xmlepg = new XMLEPG();
  const overlay = document.getElementById("overlay");
  const videoContainer = document.getElementById("video-container");
  const epgContainer = document.getElementById("epg-container");
  const searchInput = document.getElementById("search-input");
  const videoList = document.getElementById("video-list");
  const epgButton = document.getElementById("epg-button");
  const videoElement = document.getElementById("video");

  let channels = [];
  let player;
  let ui;
  let hideOverlayTimeout = null;

  overlay.addEventListener("mouseenter", () => {
    if (hideOverlayTimeout) clearTimeout(hideOverlayTimeout);
    overlay.style.display = "flex";
    videoContainer.style.display = "none";
  });
  overlay.addEventListener("mouseleave", () => {
    overlay.style.display = "none";
    videoContainer.style.display = "flex";
  });

  shaka.polyfill.installAll();

  window.onload = () => {
    player = new shaka.Player(videoElement);

    // Inizializza UI di Shaka Player (overlay e controlli)
    ui = new shaka.ui.Overlay(player, videoElement.parentElement, videoElement);
    ui.getControls();

    // Playlist M3U8 (cambia con il tuo URL)
    const githubPlaylistUrl = "https://raw.githubusercontent.com/nero081/loghi/main/canali.m3u";

    fetch(githubPlaylistUrl)
      .then((res) => {
        if (!res.ok) throw new Error("Failed to fetch playlist");
        return res.text();
      })
      .then((playlistText) => {
        parseAndSetPlaylist(playlistText);
      })
      .catch(console.error);

    searchInput.addEventListener("input", () => {
      const term = searchInput.value.toLowerCase();
      filterPlaylist(term);
    });
  };

  function parseAndSetPlaylist(content) {
    const interpreter = new M3U8Interpreter(content);
    interpreter.parse();
    channels = interpreter.getChannels();
    const urls = interpreter.getUrlTvg();

    xmlepg.setPlaylistChannels(channels);
    xmlepg.load(urls).then(() => {
      xmlepg.displayAllPrograms("epg-container", "xmlepg");
    });

    if (urls && urls.length) {
      epgButton.style.display = "block";
    }

    updatePlaylist(channels);
  }

  window.loadVideo = function (manifestUrl, licenseKey) {
    if (licenseKey && !Array.isArray(licenseKey)) {
      licenseKey = JSON.parse(decodeURIComponent(licenseKey));
    }
    if (licenseKey) {
      licenseKey.forEach(({ keyId, key }) => {
        player.configure({ drm: { clearKeys: { [keyId]: key } } });
      });
    }
    player.load(manifestUrl).catch(console.error);
    videoElement.play();
  };

  function groupChannelsByGroup(channels) {
    const groups = {};
    channels.forEach(channel => {
      const group = channel.groupTitle || "Altro";
      if (!groups[group]) groups[group] = [];
      groups[group].push(channel);
    });
    return groups;
  }

  function updatePlaylist(channelsToShow, grouped = true) {
    videoList.innerHTML = "";

    if (grouped) {
      const groups = groupChannelsByGroup(channelsToShow);

      Object.entries(groups).forEach(([groupName, groupChannels]) => {
        const groupHeader = document.createElement("li");
        groupHeader.style.fontWeight = "bold";
        groupHeader.style.cursor = "pointer";
        groupHeader.style.padding = "10px 5px";
        groupHeader.style.borderBottom = "1px solid #444";
        groupHeader.style.display = "flex";
        groupHeader.style.alignItems = "center";
        groupHeader.style.justifyContent = "space-between";
        groupHeader.style.userSelect = "none";

        const toggleIcon = document.createElement("span");
        toggleIcon.textContent = "+";
        toggleIcon.style.fontWeight = "bold";
        toggleIcon.style.marginRight = "10px";
        toggleIcon.style.fontSize = "1.2em";

        const titleSpan = document.createElement("span");
        titleSpan.textContent = groupName;

        groupHeader.appendChild(titleSpan);
        groupHeader.appendChild(toggleIcon);

        const groupList = document.createElement("ul");
        groupList.style.listStyle = "none";
        groupList.style.paddingLeft = "15px";
        groupList.style.marginTop = "5px";
        groupList.style.maxHeight = "0";
        groupList.style.overflow = "hidden";
        groupList.style.transition = "max-height 0.3s ease-out";

        groupChannels.forEach(channel => {
          const li = document.createElement("li");
          li.style.padding = "5px 0";
          li.style.display = "flex";
          li.style.alignItems = "center";
          li.style.cursor = "pointer";

          li.innerHTML = `
            <img src="${channel.tvgLogo}" alt="${channel.channelName} logo" style="width:40px; height:40px; margin-right: 10px; border-radius: 5px; object-fit: contain;" />
            <span class="video-title">${channel.channelName}</span>
          `;

          const img = li.querySelector("img");
          img.onmouseenter = () => {
            xmlepg.displayPrograms("overlay", channel.tvgId);
            overlay.style.display = "flex";
            videoContainer.style.display = "none";
            if (hideOverlayTimeout) clearTimeout(hideOverlayTimeout);
          };
          img.onmouseleave = () => {
            hideOverlayTimeout = setTimeout(() => {
              overlay.style.display = "none";
              videoContainer.style.display = "flex";
            }, 100);
          };

          li.onclick = () => {
            loadVideo(channel.manifestUrl, channel.licenseKey);
            videoList.querySelectorAll("li.active").forEach(el => el.classList.remove("active"));
            li.classList.add("active");
          };

          groupList.appendChild(li);
        });

        groupHeader.onclick = () => {
          if (groupList.style.maxHeight === "0px" || groupList.style.maxHeight === "") {
            groupList.style.maxHeight = groupList.scrollHeight + "px";
            toggleIcon.textContent = "âˆ’";
          } else {
            groupList.style.maxHeight = "0";
            toggleIcon.textContent = "+";
          }
        };

        videoList.appendChild(groupHeader);
        videoList.appendChild(groupList);
      });
    } else {
      // Mostra solo i canali senza gruppi (ricerca)
      channelsToShow.forEach(channel => {
        const li = document.createElement("li");
        li.style.padding = "10px 5px";
        li.style.display = "flex";
        li.style.alignItems = "center";
        li.style.cursor = "pointer";

        li.innerHTML = `
          <img src="${channel.tvgLogo}" alt="${channel.channelName} logo" style="width:40px; height:40px; margin-right: 10px; border-radius: 5px; object-fit: contain;" />
          <span class="video-title">${channel.channelName}</span>
        `;

        const img = li.querySelector("img");
        img.onmouseenter = () => {
          xmlepg.displayPrograms("overlay", channel.tvgId);
          overlay.style.display = "flex";
          videoContainer.style.display = "none";
          if (hideOverlayTimeout) clearTimeout(hideOverlayTimeout);
        };
        img.onmouseleave = () => {
          hideOverlayTimeout = setTimeout(() => {
            overlay.style.display = "none";
            videoContainer.style.display = "flex";
          }, 100);
        };

        li.onclick = () => {
          loadVideo(channel.manifestUrl, channel.licenseKey);
          videoList.querySelectorAll("li.active").forEach(el => el.classList.remove("active"));
          li.classList.add("active");
        };

        videoList.appendChild(li);
      });
    }
  }

  function filterPlaylist(term) {
    if (!term) {
      updatePlaylist(channels, true);  // Mostra tutti i canali raggruppati
    } else {
      const filtered = channels.filter(c => c.channelName.toLowerCase().includes(term.toLowerCase()));
      updatePlaylist(filtered, false); // Mostra solo i canali filtrati senza gruppi
    }
  }

  function openEPG() {
    epgContainer.style.display = "block";
  }
</script>
</html>
